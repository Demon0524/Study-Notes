#Linux_commands #Linux_防火墙
[toc]
> 内容参考：https://www.zsythink.net/archives/1199
# 什么是IPTables
- **iptables** 其实不是组织的防火墙。我们将其理解为一个客户端代理，用户通过iptables这个代理，将用户的安全设定执行到对应的“安全框架”中，这个“安全框架”才是真正的防火墙，这个框架的名字叫**netfilter**

- netfilter 才是真正的安全框架（framwork），**netfilter位于内核空间**

> iptables就是一个命令行工具，位于用户空间，使我们利用这个工具操作真正的框架。

netfilter/iptebles组成的linux平台下的包过滤防火墙

Netfilter是Linux操作系统核心层内部的一个数据包处理模块，具有如下功能：
1. 网络地址转换（NAT）
2. 数据包内容修改
3. 数据包过滤的防火墙功能

-------
> 尽管使用`servicer iptables start`启动“服务”，但是iptables没有一个守护进程，不应该算是真正意义上的服务，而应该算是内核提供的功能。

# IPTables-基础
由于TCP/IP协议是属于内核的一部分，所以客户端的信息会通过内核的TCP协议传输到用户空间中的web服务中。而此时，客户端报文的目标终点为web服务所监听的套接字（IP：Port）上，当web响应客户端请求时，web服务发出的响应报文的目标则为客户端，这个时候，web服务所监听的IP与端口反而变成了原点。
**netfilter才是真正的防火墙**，他是内核的一部分，所以只有通过在在内核中设置关卡，所有进出的报文都需要通过这些关卡，经过检查后，符合条件的才能放行。
于是就出现了input和output关卡，在iptables中被称之为**“链”**
![image](https://img2023.cnblogs.com/blog/2298008/202305/2298008-20230511165701465-1982733324.png)


# 表与链
- **四表**
	- [[#^f7ae14|Filter表]]
	- [[#^8e7932|NAT表]]
	- mangle表
	- rew表
- 五链
	- INPUT
	- OUTPUT
	- FORWARD
	- PREROUTING
	- POSTROUTING
## 每个表的说明
### 1. **filter表**

^f7ae14

- 实现**防火墙**功能，屏蔽或允许 端口IP


| **filter表** ||
| :--------: | ------------------------------------------------------- |
| ** 强调：主要和主机自身相关，真正负责防火墙功能的（过滤主机数据包的进出）。 **     ||\
|**filter是iptables默认使用的表，这个表定义了三个链（chains） 企业工作场景：主机防火墙**||
| **INPUT**        | **过滤进入主机的数据包**  |    
| FORWARD    |负责诸法流经主机的数据包，起转发的作用；| \
| |与NAT相关：LVS NAT模式，netipv4.ip_forward=0|
| OUTPUT     | 处理从主机发出的数据包|

### 2. **nat表**

^8e7932

- 实现nat功能
	- 共享上网（内网服务器上外网）
	- 端口映射和IP映射


|      NAT表   |    功能                                                             |
| ------- | ------------------------------------------------------------------------------------ |
| **nat**| 负责网络地址转换；  |\
|| 应用：和主机本身无关，一般用于局域网共享上网或者特殊的端口转换服务相关。                                            |\
|| 工作场景：                                                                                                |\
|| 1.用于企业路由(zebra) 或网关(iptables) ，共享上网(POSTROUTING)                                               |\
|| 2.做内部外部IP地址-对一映射(dmz) ，硬件防火墙映射IP到内部服务器，ftp服务(PREROUTING)                              |\
|| 3. WEB,单个端口的映射，直接映射80端口(PREROUTING)这个表定义了3个链， nat功能相当于网络的acl控制。和网络交换机acl类似。 |
|OUTPUT|改变主机发出数据包的目的地址|
|PREROUTING|**改变数据包的目的地址、目的端口等**|
|POSTROUTING|**局域网共享上网**|

### 3. rew表

## 参数说明
| 参数  | 含义                        |
| ---- | --------------------------- |
| -L   | **显示表中的所有规则**             |
| -n   | **不要将端口和IP反解析成对应的名字** |
| -t   | 指定表；**不指定默认是filter表**       |
| -I   | **inster**把规则加在链的第一条；**拒绝类**规则放在最上面   |
| -A   | **append**追加；加入**准许类**规则使用，把规则卸载最后    |
| -D   | delete 删除规则               |

| 参数        | 含义                                                          |
| ----------- | ------------------------------------------------------------- |
| -p          | 协议 protocal **tcp**/udp/icmp/all 指定端口的时候需要指定协议 |
| **--dport** | **目标端口** destination 指定端口 加上协议 -p tcp             |
| --sport     | 源端口 source 源                                              |
| -s          | **--source 源IP**                                             |
| -d          | --destination 目标ip                                          |
| -m          | 指定模块 multiport                                            |
| -i          | input输入的时候指定从那块网卡进来                             |
| -o |           output输出的时候指定从那块网卡出去                              |


| 参数 | 含义                                         |
| :---: | -------------------------------------------- |
| -j   | 满足条件后的动作：**DROP/ACCEPT/REJECT**     |
|      | DROP：拒绝，直接将数据丢弃不会返回信息|\
|      | ACCEPT：允许通过                             |\
|      | REJECT：拒绝，但会返回信息                   |

- F flush清除所有规则（默认规则除外）
- X 清空**用户自定义的链**
-  zero链的计数器清零（数据包和数据包字节计数器）
