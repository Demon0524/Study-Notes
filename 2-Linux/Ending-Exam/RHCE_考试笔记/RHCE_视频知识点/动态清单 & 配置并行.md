#Linux #Ending_Exam #RHCE #视频笔记
[TOC]

# 动态清单
> 实际生产环境中需要操作多台计算机或计算机更替非常快时  
> **Cobbler**等安装服务器的红帽卫星等管理服务可能 **追踪部署** 的 **裸机系统** 。
> 
## 配置动态清单

+ Ansible 支持 **动态清单脚本** ，能够使清单实时得到更新。 **以 JSON 格式输出清单** 


## 编写动态清单

- 脚本以适当的解释器行 **（#!/usr/bin/python）** 开头并且可以执行,以便 Ansible 能够执行它——通过 python 脚本识别受控主机
- 在传递 --list 选项时，简本必须显示清单中所有主机和组的 JSON 编码散列/字典

### 格式转换
> 通过ansible能够使ini格式的清单文件转换为json格式的清单文件
```sh
ansible-inventory -i [inventory_filename] --list
```
### 示例
-  ***INI*** 格式
```ini
[dev]
servera
[test]
serverb
[prod]
serverc
serverd
[balancers]
servere
[webservers:children]
prod
```

-  ***JSON*** 格式
```json
{
    "_meta": {
        "hostvars": {} /* 此处的hostvars变量可用于循环 */
    },
    "all": {
        "children": [
            "ungrouped",
            "dev",
            "test",
            "balancers",
            "webservers"
        ]
    },
    "balancers": {
        "hosts": [
            "servere"
        ]
    },
    "dev": {
        "hosts": [
            "servera"
        ]
    },
    "prod": {
        "hosts": [
            "serverc",
            "serverd"
        ]
    },
    "test": {
        "hosts": [
            "serverb"
        ]
    },
    "webservers": {
        "children": [
            "prod"
        ]
    }
}
```

初始化 `--lab project-inventory start`

使用普通用户进行管理

获取动态清单文件 

> `wget http://materials.example.com/labs/projects-inventory/inventorya.py -O inventory/inventorya.py`



# 配置并行

## 目标

- 管理并行任务---forks
  - 以数百台主机为目标，限制同时运行的节点数量，以便给控制节点减负。 **具体情况依照实际环境进行改变** 。
- 管理滚动更新---serial
  - 更新时可能需要的重启，保证服务器不同时下线，批量 运行主机，实现业务不掉线。

## 方案

-  `forks` 
  - 通过将 `forks = 5` 写入 `ansible.cfg` 实现并行任务的控制处理
-  `serial`
  - 通过将 `serial = 2` 写入 `ansible.cfg` 实现

### 代码

 
![User](https://s.gravatar.com/avatar/d5c5df8422c972607c9bfbb5e162b476?s=480&r=pg&d=https%3A%2F%2Fcdn.auth0.com%2Favatars%2Fca.png)

You

ansible.cfg最基础的配置是哪些？麻烦罗列一下

ChatGPT

ChatGPT

Ansible 的配置文件 `ansible.cfg` 可以包含许多配置项，但是最基础的配置通常包括以下部分：

1. **[defaults]**：这是默认设置部分，大多数Ansible的基本配置都在这里。
    
    - `inventory`：指定库存文件（inventory file）的路径，可以是绝对路径或相对路径。
    - `remote_user`：默认的远程用户名称，Ansible将用它来登录到远程主机。
    - `host_key_checking`：是否检查远程主机的SSH密钥，通常在自动化环境中设置为 `False`。
    - `ask_pass`：是否在运行时提示输入SSH密码，默认是 `False`。
    - `private_key_file`：指定SSH私钥文件的路径。
    - `timeout`：设置网络连接超时时间（秒）。
2. **[privilege_escalation]**：这部分涉及特权提升的设置。
    
    - `become`：是否启用特权提升，默认是 `False`。
    - `become_method`：特权提升的方法，默认是 `sudo`。
    - `become_user`：特权提升后的用户，默认是 `root`。
    - `become_ask_pass`：是否在运行时提示输入特权提升密码，默认是 `False`。
3. **[ssh_connection]**：涉及SSH连接的设置。
    
    - `ssh_args`：SSH命令的参数，例如可以设置不同的SSH选项。
    - `pipelining`：是否启用SSH管道化以加快执行速度，默认是 `False`。
    - `control_path`：SSH用于持久连接的控制路径设置。

这些是最基本的配置项，你可以根据需要在配置文件中设置这些选项。此外，还有很多其他的配置项可以根据你的环境和需求进行自定义。一个典型的 `ansible.cfg` 文件可能看起来像这样：

iniCopy code


``` perl
[defaults] 
inventory = ./inventory 
remote_user = myuser 
host_key_checking = False 
ask_pass = False  
[privilege_escalation] 
become = True 
become_method = sudo 
become_user = root 
become_ask_pass = False  
[ssh_connection] 
ssh_args = -o 
ControlMaster=auto -o 
ControlPersist=60s 
pipelining = True 
control_path = /tmp/ansible-ssh-%%h-%%p-%%r`
```
```perl
[defaults]
inventory = ./inventory
remote_user = myuser
host_key_checking = False
ask_pass = False

[privilege_escalation]
become = True
become_method = sudo
become_user = root
become_ask_pass = False

[ssh_connection]
ssh_args = -o ControlMaster=auto -o ControlPersist=60s
pipelining = True
control_path = /tmp/ansible-ssh-%%h-%%p-%%r
```

