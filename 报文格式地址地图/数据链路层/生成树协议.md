

[TOC]

#ComputerNetwork
#🌐网络报文格式

# 1、什么是生成树

==**作用于数据链路层**==

> **作用**：

- 解决二层网络环路
  - 交换机之间存在 **冗余路径** 和 **泛洪机制**  
- 防止网络风暴
- 防止MAC地址表的不正确
- 防止数据帧的重复拷贝



> **生成树协议有哪些**：

- **公有**（工业标准）

  - STP（802.1D 标准生成树）
  - RSTP（802.1W 快速生成树）

  - MST（802.1S 多生成树）
    - 同时兼容STP和RSTP
      - MSTP与运行802.1W交换机之间运行802.1W
      - MSTP与运行802.1D交换机之间运行802.1D
    - 一个VLAN一棵树



## 1.1、STP--标准生成树

> 端口选举

- **根网桥选举：**
  - 具有做优BID（网桥ID）的交换机作为根桥
- **根端口：**
  - 用于接受来自根的BPDU信息，只能存在于非根桥之上，并且一个交换机只能存在一个
  - 1、最小COP^[Cost of Path--路径开销]值
  - 2、发送方最小的BID
  - 3、发送方的PID
- **指定端口：**
  - 用于收发BPDU信息，存在于每一条链路中，一条只能存在一个指定端口，根网桥的所有借口全为指定端口
  - 1、接口所属交换机上根端口到达网桥的COP值
  - 2、本交换机BID
  - 3、本地的PID
- **阻塞端口：**
  - 逻辑上打破接口
  - 剩余端口就是阻塞端口



> 状态

- **Blocking 阻塞状态：** 不能收发BPDU和数据，被动等待==20s==进入下一个状态
- **Listening 监听状态：** 可以收发BPDU，不能收发数据，进行STP选举，被动等待下一个forward delay ==15s==进入下一个状态
- **Learing 学习状态：** 可以收发BPDU，不能收发数据，可以学习BPDU中的源MAC地址（==MAC地址学习状态==），被动等待下一个forward delay ==15s==进入下一个状态
- **Forwarding 转发状态：** 可以收发BPDU和数据，MAC地址学习和生成树接口状态切换完成



> 端口与状态结合

- **Blocking-Listening（20s）：** 选举根桥、根接口（剩下都是指定接口）
- **Listening-Learning（15s）：** 选举指定接口与非指定接口（被阻塞）
- **Learning-Forwarding（15s）：** 学习MAC转发表



> 注意

- 生成树会强制老化交换机的MAC表
- **缺点：** 50s收敛时间太长



## 1.2、RSTP--快速生成树



> 产生原因

 ==**解决STP的收敛时间过长的问题**==

- **概述：**
  - STP中的Blocking-Listening其实就是为了选出根网桥而设定的，那么可以 **将这两个状态合并** 
  - Forward delay 15s的选举时间太慢， **增加一种预约机制，或者说备胎机制；将来出现故障后，直接上位顶上，就不存在选举了** 

- **详解：**
  - discarding状态
  - 增加两个端口角色：替代端口（AP）、备份端口（BP）
  - PA机制，即分布式收敛

> 端口角色

- **根端口（RP）：** 与STP的相同；用于接受来自根的BPDU信息，只能存在于非根桥之上，并且一个交换机只能存在一个
- **指定端口（DP）：** 与STP的相同；用于收发BPDU信息，存在于每一条链路中，一条只能存在一个指定端口，根网桥的所有借口全为指定端口
- **替代端口（AP）：** 竞选根端口失败成为替代端口，作为根端口的备份；
- **备份端口（BP）：** 竞选指定端口失败成为备份端口，作为指定端口的备份；



> 端口状态

- **Discarding 丢弃状态：** 不转发数据帧和数据，可以收BPDU（能够知道谁是根）；不学习MAC地址表，只选端口
- **Learing 学习状态：** 不转发数据帧；学习MAC地址表，参与计算生成树，收发BPDU
- **Forwarding 转发状态：** 正常收发数据帧；学习MAC地址表，参与计算生成树，收发BPDU

==**在802.1W（RSTP）中为了加快收敛，初始所有交换机状态都是Discarding状态；都可以发送BPDU**==

**Dis->For最长只需要30s，根丢失** 



> P/A机制

- **概述：**
  - 交换机在启动后端口会都是转发状态（ **Discarding** ）；然后互相发送 **Proposal位^[Proposal位--建议位]** 请求个对方；交换机再通过比较接受的BPDU判断选举根桥；其他交换机为了防止临时环路端口状态都是 **Discarding** ，根桥会发送 **Proposal** 的协商请求，非根桥收到后会将端口变为 **Forwarding** 然后回复 **Agreement BPDU^[协议BPDU]**  

- **选举新的指定端口“Proposal-Agreement”**：
  - 对于某个交换机的某个接口如果发生状态的变化，那么这个接口将向此链路发送带有状态为P建议；此时收到此P建议的交换机现将==自己的所有接口设置成阻塞状态（防环）== ，然后判断
    - 判断建议的信息与原本的信息谁更准
    - 总结：
      - A经过的接口的被称为转发状态
      - 一旦某一个交换机==没有回应A==，那么它将==不会向下蔓延==
      - 一般来说，发出A的接口是==根接口==，收到A的接口是==转发接口==
      - **这个状态不依赖计时器**



> 特点

1. 自动集成Uplinkfast^[Uplinkfast--在STP收敛过程中，一些终端站点可能会不可达，这是基于站点所连接交换机端口的STP状态而定。这打乱网络连接，于是关键是减少STP的收敛时间和网络受影响的时间。 当链路或交换机故障，或STP重新配置后，==UplinkFast可以加速选择一个新的根端口。根端口立即进入转发状态==，Uplinkfast通过减少最大更新速率来限制突发多播流量。]
2. 支持Portfast^[边缘端口（portfast）--是指==不直接与任何交换机连接，也不通过端口所连接的网络间接与任何交换机相连的端口==。 可以通过下面两种途径来配置端口为边缘端口或者非边缘端口。用户如果将某个端口指定为边缘端口，那么当该端口由堵塞状态向转发状态迁移时，这个端口可以实现快速迁移，而无需等待延迟时间。用户只能将与终端连接的端口设置为边缘端口。该参数对所有生成树实例有效，也就是说，==当端口被配置为边缘端口或非边缘端口时，该端口在所有生成树实例上都被设置为边缘端口或非边缘端口==。]（需要手动开启）
3. 自动集成Backonefast^[BackboneFast是对UplinkFast的一种补充，==UplinkFast能够检测直连链路的失效，BackboneFast是用来检测间接链路的失效==。当启用了BackboneFast的==交换机检测到间接链路失效之后，会马上使阻塞的端口进入监听状态==，少了20S的老化时间。]（节约50s）
4. 所有交换机都发送config-BPDU
5. 配置BPDU超时时间为6s
6. RSTP重收敛时分布式的（类似于EIGRP的DUAL算法）





## 1.3、MSTP--多生成树
e
> 产生原因

- 主备分流结构会造成环路（无法实现负载均衡）

  1. Cisco的RSTP：一个VLAN一棵树

  2. 公有RSTP（802.1W）：整个交换网络的VLAN一棵树

- 当生成树网络特别大时，BPDU传递时间变长，出现拓扑变更概率变高，导致收敛时间和稳定性变差-- **STP、RSTP收敛速度慢**

  1. STP：50s根故障；其他交换机故障；阻塞其他接口切换转发

  2. RSTP：30s根故障；2s内一台交换机切换


> 解决方法

采用多棵生成树来实现负载分担，引入一个概念：实例。 **一个实例一棵树** ，可以将不同的VLAN划分到实例中，来实现 **流量的负载分担、链路的冗余备份** 

- **多生成树** （利用BID参数来分辨多棵生成树的BPDU）

  - 优先级+MAC优先级是4096的倍数

- **通过划分区域来解决网络规模大的问题**

  - 参数对比：

    1. 具有相同的域名 **name**
    2.  **regin** 值相同的 **revision**
    3. 市里映射相同 **instance** 树的标识（16-64）——有点像vlan1--->默认所有vlan都属于instance0

    以上三者都相同则表示在同一个==**MST域**==

- **区域间防环**
  - 区域间的生成树由实例0来维护，具体是每个区域内实例0的根来维护生成树
    - **CST**：==区域间==的生成树
    - **IST**：==区域内==的生成树
    - **CIST**：==整个区域==的生成树
  - 注意：配置时，一定要清楚 **instance0** 里面有哪些 **VLAN** ，默认所有的 **VLAN** 都属于 **instance0**







# 2、帧格式解析

> [STP/RSTP/MSTP帧格式](http://www.023wg.com/message/message/cd_feature_mstp_message_format.html)

## 2.1、STP帧格式

> 

![STP帧格式](http://www.023wg.com/message/message/image/mstp-format-stp.png)



-tx-
| **字段内容**                    | **说明**                                       |
| --------------------------- | ------------------------------------------ |
| Protocol Identifier         | 协议ID=“0”                                 |
| Protocol Version Identifier | 协议版本标识符： |\
||==STP为0；RSTP为2；MSTP为3==|
| BPDU Type                   | 0x00：STP的Configuration BPDU  |\
| | - 0x00：STP的Configuration BPDU  |\
| | - 0x80：STP的TCN BPDU^[TCN BPDU--Topology Change Notification BPDU--拓扑更改通知]|\
| | - 0x02：RST BPDU（Rapid Spanning-Tree BPDU）或者MST BPDU（Multiple Spanning-Tree BPDU） |
| Flags  | 对于“标记域”（Flags），第一个bit（左边、高位bit）表示“TCA（拓扑改变响应）”，最后一个bit（右边、低位bit）表示“TC（拓扑改变）”。|
|  Root Identifier（RID） |    网桥ID都是8个字节---前两个是网桥优先级，后6个字节是网桥MAC地址       |
| Root Path Cost | 根路径开销，本端口累积到根桥的开销 |
| Bridge Identifier（BID） | 发送者BID，本交换机的BID |
| Port Identifier（PID） | 发送端口PID，发送该BPDU的端口PID |
| Message Age | 该BPDU的消息年龄 |
| Max Age | 消息老化年龄 |
| Hello Time | 发送两个相邻BPDU间的时间间隔 |
| Forward Delay | 控制Listening和Learning状态的持续时间 |



## 2.2、RSTP帧格式
>在BPDU的格式上，除了保证和STP格式基本一致之外，RSTP做了一些小变化。
> - 在Type字段上，配置BPDU类型为2，版本号为2；所以运行STP的交换机收到该类BPDU时会丢弃
> - 在Flag字段上，把原有保留的中间6位使用起来

**RSTP Flag字段：**
- Bit7：**TCA**
- Bit6：**Agreement**
- Bit5：**Forwarding**
- Bit4：**Learning**
- Bit3和2：**端口角色**
	- ==00==：**未知**
	- ==01==：**根端口**
	- ==10==：**Alternate / Backup**
	- ==11==：**指定端口**
- Bit1：**Proposal**
- Bit0：**TC**

## 2.3、MSTP帧格式
>- 多生成树协议MSTP是生成树协议的一种，用于消除网络环路，它兼容STP和RSTP，并且弥补了两者的缺陷。
>- MSTP使用==**多生成树桥协议数据单元**MST BPDU==（Multiple Spanning Tree Bridge Protocol Data Unit）作为生成树计算的依据。
>- MST BPDU报文用来计算生成树的拓扑、维护网络拓扑以及传达拓扑变化记录。

![MSTP帧格式](http://www.023wg.com/message/message/image/mstp-format.png)

- ==无论是域内的SMT BPDU还是域间，**前35个字节和RST BPDU相同**==
- ==从**36个字节开始是MSTP专有字段**。最后的MSIT配置信息字段由若干MSIT配置信息组连缀而成。==

MST BPDU中的主要信息如下：

-tx-
| **字段内容**                    | **说明**                                       |
| --------------------------- | ------------------------------------------ |
| Protocol Identifier         | 协议ID=“0”   |
| Protocol Version Identifier | 协议版本标识符： |\
| |==STP为0；RSTP为2；MSTP为3==|
| BPDU Type  | 0x00：STP的Configuration BPDU  |\
| | - 0x00：STP的Configuration BPDU  |\
| | - 0x80：STP的TCN BPDU|\
| | - 0x02：RST BPDU（Rapid Spanning-Tree BPDU）或者MST BPDU（Multiple Spanning-Tree BPDU） |
| Flags  | 对于“标记域”（Flags），第一个bit（左边、高位bit）表示“TCA（拓扑改变响应）”，最后一个bit（右边、低位bit）表示“TC（拓扑改变）”。|
|  Root Identifier（RID） |    网桥ID都是8个字节---前两个是网桥优先级，后6个字节是网桥MAC地址       |
| Root Path Cost | 根路径开销，本端口累积到根桥的开销 |
| Bridge Identifier（BID） | 发送者BID，本交换机的BID |
| Port Identifier（PID） | 发送端口PID，发送该BPDU的端口PID |
| Message Age | 该BPDU的消息年龄 |
| Max Age | 消息老化年龄 |
| Hello Time | 发送两个相邻BPDU间的时间间隔 |
| Forward Delay | 控制Listening和Learning状态的持续时间|
| Version 1 Length | Version 1 BPDU的长度，值固定为0 |
| Version 3 Length | Version3 BPDU的长度 |
| MST Configuration Identifier | MST配置标识，表示MST域的标签信息，包含4个字段 |\
|  | - Configuration Identifier Format Selector[39]：固定为0   |\
|  | - Configuration Name[40-71]：“域名”，32字节长字符串 |\
|  | - Revision Level[72-73]：2字节非负整数 |\
|  | - Configuration Digest[74-89]：利用HMAC-MD5算法将域中VLAN和实例的映射关系机密成16字节的摘要 |\
|  | ==只有MST Configuration Identifier中的四个字段完全相同，并且互联的交换机，才属于同一个域== |
